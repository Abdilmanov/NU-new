<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Навигация по НУ</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      .search-menu {
        display: none;
        left: 50px;
        top: -75px;
        position: relative;
        white-space: nowrap;
        width: auto;
        min-width: 450px;
        height: auto;
        background-color: white;
        padding-bottom: 1em;
        border-radius: 1em;
      }
      .search-item {
        white-space:nowrap;
        margin: 0 2em;
        margin-top: 0;
        margin-bottom: 0;
      }
      input[type="text"] {
        margin: 0 !important;
      }
      .collection {
        margin: 0 !important;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
          0 3px 1px -2px rgba(0, 0, 0, 0.12), 0 1px 5px 0 rgba(0, 0, 0, 0.2);
      }
      .collection .collection-item {
        font-size: 16px;
        color: #26a69a;
        line-height: 22px;
        padding: 14px 16px;
      }
      .collection .collection-item:hover {
        background-color: #eee !important;
        cursor: pointer;
      }
      #block_complete {
        display: none;
      }
      #nameroom_complete {
        display: none;
      }
      #roomnum_complete {
        display: none;
      }
      .input-field > label:not(.label-icon).active {
        -webkit-transform: translateY(-14px) scale(0.8);
        transform: translateY(-6px) scale(0.8) !important;
        -webkit-transform-origin: 0 0;
        transform-origin: 0 0;
      }
      .activeUl {
        display: block !important;
      }
      .button {
        /* display: inline-block; */
        float: right;
        align-items: center;
        text-align-last: right;
        justify-content: center;
        margin-top: 20px;
        margin-right: 10px;
        margin-left: 20px;
      }
      .small-padding {
        padding: 0 8px;
      }
      .danger {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 5px 14px;
        color: white;
        border-radius: 10px;
        background-color: #f36860;
      }
      #dangerLi {
        color: white;
        background-color: #f36860 !important;
      }
      #search_ul {
        display: none;
      }
      .search-item {
        display: inline-block;
      }
      .button-stairs-elevator {
        display: inline-block;
        margin: 0 15px 15px 30px;
      }
      .dir-name {
        font-size: 18px;
        padding: 10px 10px 10px 28px!important;
      }
      .close {
        color: #777;
        font: 14px/100% arial, sans-serif;
        /* position: absolute; */
        text-decoration: none;
        text-shadow: 0 1px 0 #fff;
        padding: 10px!important;
      }
      .close:hover {
        opacity: 1;
        cursor: pointer;
      }
      .close:after {
        content: 'X';
      }
      .border-bottom {
        border-bottom: 1px solid #e0e0e0;
      }
      .title {
        margin-bottom: 15px!important;
      }

      .floorBlockInfo {
        max-height: 150px;
        overflow-y: auto;
        background-color: white;
        position: absolute;
        top: 90px;
      }
      .li-floorBlockInfo {
        text-align: center;
        height: 30px;
        width: 30px;
        font-size: 16px;
        padding: 5px;
        list-style-type: none;
        border-top: 1px solid #d4d4d4;
      }
      .li-floorBlockInfo:hover {
        background-color: #f0f0f0;
        cursor: pointer;
      }
      .li-floorBlockInfo:active {
        background-color: #f0f0f0;
      }
      .li-floorBlockInfo:visited {
        background-color: #f0f0f0;
      }

      /* .direction-div {
        display: none;
      } */
      /* .open {
        display: inline-block;
      }
      .close {
        display: none;
      } */
      /* .input-field > label:not(.label-icon).active {
          -webkit-transform: translateY(-14px) scale(0.8);
          transform: translateY(-2px) scale(0.9) !important;
          -webkit-transform-origin: 0 0;
          transform-origin: 0 0;
      } */
    </style>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.13/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.13/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
      require([
        // **Map**
        "esri/Map",
        "esri/views/MapView",
        "esri/views/SceneView",
        // **Search**
        "esri/tasks/QueryTask",
        "esri/tasks/support/Query",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        // **Direction**
        // "esri/widgets/Directions",
        // "esri/tasks/Locator",
        // "esri/symbols/SimpleMarkerSymbol",
        "esri/tasks/RouteTask",
        "esri/tasks/support/RouteParameters",
        "esri/tasks/support/FeatureSet",
        // ** Layers**
        "esri/layers/FeatureLayer",

        "esri/core/watchUtils",
        "esri/geometry/Geometry",
        "esri/geometry/Extent",
        // "esri/tasks/Locator",
        "esri/geometry/Point",
        "esri/geometry/SpatialReference"
      ], function(
        // **Map**
        Map,
        MapView,
        SceneView, 
        // **Search**
        QueryTask,
        Query,
        Graphic,
        GraphicsLayer, 
        // **Direction**
        // Directions,
        // Locator,
        // SimpleMarkerSymbol,
        RouteTask, 
        RouteParameters, 
        FeatureSet,
        // **Layers**
        FeatureLayer,

        watchUtils,
        Geometry,
        Extent,
        // Locator,
        Point,
        SpatialReference
      ) {
        
        // **Map**
        var map = new Map({
          // basemap: "topo-vector"
        });
        var defaultViewCenter = {
          center: [71.397117, 51.090505]
        }
        // var view = new SceneView({
        var view = new MapView({
          container: "viewDiv",
          map: map,
          center: [71.397117, 51.090505],
          scale: 4000,
          constraints: {
            minScale: 8000,
            maxScale: 500,
          }
        });
        
        var floorDiv = document.getElementById('floorBlockInfo');
        var search = document.getElementById('search');
        var search_input = document.getElementById('search_input');
        var search_menu = document.getElementById('search_menu');
        var search_ul = document.getElementById('search_ul');
        var search_button = document.getElementById('search_button');

        // **Layers**
        let anotherInfo = [
          {
            id: 0,
            title: "Наименование блоков"
          },
          {
            id: 47,
            title: "Ограждение"
          },
          {
            id: 48,
            title: "Дороги"
          },
          {
            id: 50,
            title: "Газоны"
          },
          {//-
            id: 51,
            title: "Клумбы"
          },
          {
            id: 52,
            title: "Здания и сооружения"
          }
        ];

        let floorBlockInfo = [
          {
            block_id: 6,
            floor_id: 7,
            title: '1',
            name: '1 этаж'
          },
          {
            block_id: 9,
            floor_id: 10,
            title: 'M1',
            name: 'M1 этаж'
          },
          {
            block_id: 12,
            floor_id: 13,
            title: '2',
            name: '2 этаж'
          },
          {
            block_id: 15,
            floor_id: 16,
            title: 'M2',
            name: 'M2 этаж'
          },
          {
            block_id: 18,
            floor_id: 19,
            title: '3',
            name: '3 этаж'
          },
          {
            block_id: 21,
            floor_id: 22,
            title: '4',
            name: '4 этаж'
          },
          {
            block_id: 24,
            floor_id: 25,
            title: '5',
            name: '5 этаж'
          },
          {
            block_id: 27,
            floor_id: 28,
            title: '6',
            name: '6 этаж'
          },
          {
            block_id: 30,
            floor_id: 31,
            title: '7',
            name: '7 этаж'
          },
          {
            block_id: 33,
            floor_id: 34,
            title: '8',
            name: '8 этаж'
          },
          {
            block_id: 36,
            floor_id: 37,
            title: '9',
            name: '9 этаж'
          },
          {
            block_id: 39,
            floor_id: 40,
            title: '10',
            name: '10 этаж'
          },
          {
            block_id: 42,
            floor_id: 43,
            title: '11',
            name: '11 этаж'
          },
          {
            block_id: 45,
            floor_id: 46,
            title: '12',
            name: '12 этаж'
          },
        ]

        // add Layer to map
        const addLayer = (id, title, type) => {
          if (type == "floor") {
            let layer = new FeatureLayer({
              id: "floor",
              title: title,
              url:
                "https://kas.nu.edu.kz/arcgis/rest/services/CampusMap2d_MIL1/MapServer/",
              layerId: id,
              popupTemplate: {
                title: "Информация по блоку",
                content: "<b>Блок: </b> {name}</br>"
              }
            });
            map.layers.add(layer);
          } else if (type == "room") {
            let layer = new FeatureLayer({
              id: "block",
              title: title,
              url:
                "https://kas.nu.edu.kz/arcgis/rest/services/CampusMap2d_MIL1/MapServer/",
              layerId: id,
              popupTemplate: {
                title: "Информация по кабинету",
                content: 
                  "<b>Кабинет: </b> {roomnum} ({nameroom})</br>"+
                  "<b>Блок: </b> {block}</br>"+
                  "<b>Этаж: </b> {floor}</br>"+
                  "</br>"+
                  "<a class='waves-effect waves-light btn-small small-padding'"+
                  "onClick='createDirectionFeature({roomnum})' style='color: white!important;'>"+
                  "<i class='material-icons left medium-margin'>transfer_within_a_station</i>Построить маршрут</a></br>"
              }
            });
            map.layers.add(layer);
          } else {
            let layer = new FeatureLayer({
              id: "another",
              title: title,
              url:
                "https://kas.nu.edu.kz/arcgis/rest/services/CampusMap2d_MIL1/MapServer/",
              layerId: id
            });
            map.layers.add(layer);
          }

        }

        // room request on layers
        window.createDirectionFeature = (roomnum) => {
          console.log(roomnum)
          let sqlTxt = "roomnum = '" + roomnum + "'";
          let params = new Query({
            where: sqlTxt
          });
          params.outFields = ["roomnum"];
          
          params.returnGeometry = true;
          params.returnDistinctValues = false;

          var qTask = new QueryTask({
            url: `https://kas.nu.edu.kz/arcgis/rest/services/NU/blockRoomsAddress/MapServer/0`
          });

          qTask
            .execute(params)
            .then(getResultsFeature)
            .catch(promiseRejected);
        }

        var finish_point;
        // get request
        const getResultsFeature = (response) => {
          let geom = response.features[0].geometry.clone();
          finish_point = {
            type: "point",
            latitude: geom.latitude,
            longitude: geom.longitude
          }
          getRoute(false);
        }
        // find Floor
        const addFloorUI = title => {
          let li = document.createElement('li');
          li.setAttribute('id', title);
          li.setAttribute('class', 'li-floorBlockInfo');
          li.innerHTML = title;
          floorDiv.appendChild(li);
        }

        // remove/add floor layer
        const findLayer = floor => {
          if (floor != floor_visible_old) {
            let info;
            floorBlockInfo.findIndex(el => {
              if (floor == el.title) {
                info = el;
                return true;
              }
            })
            let remove_index = [];
            map.layers.items.forEach((el, index) => {
              if (el.title == floor_visible_old) {
                remove_index.push(index);
              }
            })
            remove_index.reverse().forEach(el => {
              map.layers.removeAt(el);
            })
            
            addLayer(info.floor_id, info.title, "floor")
            addLayer(info.block_id, info.title, "room")
            floor_visible_old = floor;
            correctOrderLayers();
          }
        }
        
        // points,route,search_result over NU layers 
        const correctOrderLayers = () => {
          let remove_index = [];
          map.layers.items.forEach((el, index) => {
            if (
              el.title == start_point_graphic.title ||
              el.title == finish_point_graphic.title ||
              el.title == search_result_graphic.title ||
              el.title == route_graphic.title
            ) {
              remove_index.push(index);
            }
          })
          remove_index.reverse().forEach(el => {
            map.layers.removeAt(el);
          })
          map.add(start_point_graphic);
          map.add(finish_point_graphic);
          map.add(search_result_graphic);
          map.add(route_graphic);
        }

        // add another layers
        anotherInfo.forEach(el => {
          addLayer(el.id, el.title, "another");
        })

        // add floor to UI
        floorBlockInfo.forEach(el => {
          addFloorUI(el.title);
        })
        // addFloorUI('all');???

        // **Search**
        // add Graphic
        var start_point_graphic = new GraphicsLayer({
          title: "Терминал"
        });
        var finish_point_graphic = new GraphicsLayer({
          title: "Конечная точка"
        });
        var search_result_graphic = new GraphicsLayer({
          title: "Поиск"
        });
        var route_graphic = new GraphicsLayer({
          title: "Маршрут"
        });
        

        // **Direction** 10.10.17.13:6443  kazaerospace01 kas.nu.edu.kz
        var stairs_url =
          "https://kas.nu.edu.kz/arcgis/rest/services/NU/routeStairs/NAServer/%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82";
        var elevator_url =
          "https://kas.nu.edu.kz/arcgis/rest/services/NU/Routeelevator/NAServer/%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82";
        // var elevator_url = // new url ???
        //   "https://kazaerospace01/arcgis/rest/services/NU/RouteSeparate/NAServer/%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82";
        var routeTaskStairs = new RouteTask({
          url: stairs_url
        });
        var routeTaskElev = new RouteTask({
          url: elevator_url
        });
        // ArcGIS Online hosted service proxy
        var standartRouteTask = new RouteTask({
          url:
            // "https://utility.arcgis.com/usrsvcs/appservices/srsKxBIxJZB0pTZ0/rest/services/World/Route/NAServer/Route_World"
            "https://utility.arcgis.com/usrsvcs/appservices/36Pkp2TrX2alWMMY/rest/services/World/Route/NAServer/Route_World/solve"
        });

        // var locator = new Locator ({
        //   url: "https://kas.nu.edu.kz/arcgis/rest/services/NU/RoomsLocSF/GeocodeServer"
        // })

        // var directionsWidget = new Directions({
        //   view: view,
        //   routeServiceUrl: stairs_url,
        //   searchProperties: {
        //     popupEnabled: true,
        //     resultGraphicEnabled: true,
        //     searchAllEnabled: false,
        //     activeSourceIndex: 1,
        //     sources: [
        //       {
        //         locator: new Locator({
        //           url:
        //             "https://kas.nu.edu.kz/arcgis/rest/services/NU/RoomsLocSF/GeocodeServer"
        //         }),
        //         outFields: ["*"]
        //       }
        //     ]
        //   }
        // }); 

        var floor_visible_old = "1";
        var start_point = {
          type: "point",
          // longitude: 71.39519775578684,
          longitude: 71.39515775578684,
          latitude: 51.09080198480889,
        };
        view.when(function() {
          search_menu.style.display = "block";
          view.ui.add(search_menu, "top-left");
          view.ui.add(floorDiv, 'top-left');
          // view.ui.add(directionsWidget, "bottom-right");
          
          // click to Floor
          floorDiv.addEventListener('click', e => {
            findLayer(e.target.id);
          });
          addLayer(floorBlockInfo[0].floor_id, floorBlockInfo[0].title, "floor");
          addLayer(floorBlockInfo[0].block_id, floorBlockInfo[0].title, "room");
          map.add(start_point_graphic);
          map.add(finish_point_graphic);
          map.add(search_result_graphic);
          map.add(route_graphic);
          
          // map.layers.findIndex(el => {
          //   console.log(el)
          // })

          // search_button.addEventListener('click', (e) => {
          //   let pulse = document.querySelector("a.waves-effect");
          //   if (pulse.classList.contains("pulse")) {
          //     search_result_graphic.removeAll();
          //     doQueryResult();
          //   }
          // })

          // Проверка клика
          document.body.addEventListener("click", function(e) {
            // console.log(e)
            let src_el = e.srcElement;
            let activeUl = document.querySelector(".activeUl");
            // Открыт ли dropdown
            if (activeUl) {
              // console.log(e)
              // Клик был по dropdown
              if (src_el.className == "collection-item" && src_el.id != "dangerLi") {
                let text_li = src_el.id;
                document.querySelector("#search_input").focus();
                search_input.value = text_li;
                finish_point_graphic.removeAll();
                search_result_graphic.removeAll();
                route_graphic.removeAll();
                view.popup.close();
                view.ui.empty("top-right");
                // findLocator(search_input.value);
                doQueryResult();
                // pulseAnimation(true);
                CloseDropdown();
                // Клик был не по dropdown
              } else {
                let check_active = false;
                let next_el = e.srcElement.nextElementSibling;
                if (next_el) {
                  if (next_el.classList) {
                    next_el.classList.forEach((el) => {
                      if (el == "activeUl") {
                        // console.log("find activeul");
                        check_active = true;
                      }
                    });
                  }
                }
                // Закрывает dropdown если открыт
                if (!check_active) {
                  CloseDropdown();
                }
              }
            }
          });// click

          // **Direction**
          
          addGraphic("start", start_point);
          
          // var left_xmin = 7943853.67;
          // var left_xmax = 7947928.01;
          // var right_xmin = 7947688.98;
          // var right_xmax = 7951763.32;
          // var top_ymin = ;
          // var bottom_ymax = ;
          // Watch view's extent property changed.
          watchUtils.watch(view, "extent", function() {
            // Get the new extent of the view only when view crossed the border.
            if (view.extent) {
              if ((view.extent.xmin < 7943853.67 && view.extent.xmax < 7947928.01)//left
              || (view.extent.ymin > 6637894.10 && view.extent.ymax > 6640244.22)//top
              || (view.extent.xmin > 7947688.98 && view.extent.xmax > 7951763.32)//right
              || (view.extent.ymin < 6634698.94 && view.extent.ymax < 6637126.94)) //bottom
              {
                  view.goTo(defaultViewCenter.center);
              }
            }
          });

          // view.on("click", function(event) {
          //   if (view.graphics.length === 1) {
          //     addGraphic("finish", checkFinishPoint(event.mapPoint));
          //     // Call the route service
          //     getRoute();
          //   } else {
          //     view.graphics.removeAll();
          //     addGraphic("start", start_point);
          //     addGraphic("finish", checkFinishPoint(event.mapPoint));
          //     getRoute();
          //   }
          // });

          // let select = document.createElement("select");
          // select.setAttribute(
          //   "class",
          //   "esri-directions__travel-modes-select esri-select"
          // );
          // select.setAttribute("id", "switch");
          // select.setAttribute("aria-label", "лестница");
          // select.setAttribute("title", "лестница");
          // // create stairs/elevator
          // let option1 = document.createElement("option");
          // let option2 = document.createElement("option");
          // option1.setAttribute("value", "1");
          // option1.innerHTML = "Лестница";
          // option2.setAttribute("value", "2");
          // option2.innerHTML = "Лифт";
          // select.append(option1);
          // select.append(option2);
          // // add select to widget
          // setTimeout(() => {
          //   let div_splitter = document.querySelector(
          //     "div.esri-directions__section-splitter"
          //   );
          //   div_splitter.before(select);
          // }, 1000);
          // // check and direction request
          // let select_index = select.selectedIndex;
          // select.addEventListener("click", function() {
          //   if (select_index != select.selectedIndex) {
          //     if (select.selectedIndex == 0) {
          //       directionsWidget.routeServiceUrl = stairs_url;
          //       directionsWidget.getDirections();
          //     } else if (select.selectedIndex == 1) {
          //       directionsWidget.routeServiceUrl = elevator_url;
          //       directionsWidget.getDirections();
          //     }
          //     select_index = select.selectedIndex;
          //   }
          // });

        });
        
        // create finish point
        const checkFinishPoint = (latitude, longitude) => {
          let finish_point = {
              type: "point",
              latitude: latitude,
              longitude: longitude
          }
          return finish_point;
        }

        // when input changed
        // search_input.oninput = (event) => { keydown, keypress, keyup
        search_input.addEventListener("keyup", (event) => {
          CloseDropdown();
          clearUlListSelf();
          let value = event.srcElement.value;
          // console.log(value)
          if (!value == "") {
            doQuery(value);
          } else {
            console.log("input is empty");
          }
        })
        //input.addEventListener('input', updateValue);
        
        // // keypress
        // search_input.addEventListener("keypress", function(e) {
        //   keyPress(e);
        // });
        // // // keydown
        // search_input.addEventListener("keydown", function(e) {
        //   keyDown(e);
        // });
        // // // paste
        // search_input.addEventListener("paste", function(e) {
        //   paste(e);
        // });
        // const keyPress = (e) => {
        //   var code = e.charCode || e.keyCode || e.which;
        //   // Check for tab and arrow keys (needed in Firefox)
        //   if (
        //     code !== 9 &&
        //     (code < 37 || code > 40) &&
        //     // and CTRL+C / CTRL+V
        //     !(e.ctrlKey && (code === 99 || code === 118 || code === 97))
        //   ) {
        //     e.preventDefault();
        //     var char = String.fromCharCode(code);
        //     format_and_pos(char);
        //   }
        // };
        // const keyDown = (e) => {
        //   if (e.keyCode === 8 || e.keyCode === 46) {
        //     // backspace or delete
        //     e.preventDefault();
        //     format_and_pos("", this.selectionStart === this.selectionEnd);
        //   } else if (e.keyCode === 13) {
        //     // doQuery(input.value, 5);
        //     console.log("keyCode=13 => ", e);
        //   }
        // };
        // const paste = (e) => {
        //   e.preventDefault();
        //   let paste = (event.clipboardData || window.clipboardData).getData(
        //     "text"
        //   );
        //   format_and_pos(paste);
        //   // for (var i = 0; i < paste.length; i++) {
        //   //   format_and_pos(name, paste.charAt(i));
        //   // }
        // };
        // // check entered char
        // const format_and_pos = (char, backspace) => {
        //   var input = search_input;
        //   var start = 0;
        //   var end = 0;
        //   var pos = 0;
        //   var value = input.value;
        //   if (char !== false) {
        //     start = input.selectionStart;
        //     end = input.selectionEnd;
        //     if (backspace && start > 0) {
        //       // handle backspace onkeydown
        //       start--;
        //     }
        //     // To be able to replace the selection if there is one
        //     value = value.substring(0, start) + char + value.substring(end);
        //     pos = start + char.length; // caret position
        //   }
        //   input.value = value;
        //   if (char !== false) {
        //     input.setSelectionRange(pos, pos);
        //   }
        //   // pulseAnimation(false);
        //   // Если поля всех поисков пусты
        //   if (!search_input.value) {
        //     console.log("input is empty");
        //     CloseDropdown();
        //     clearUlListSelf();
        //   // Если есть значение в поле поиска
        //   } else {
        //     // console.log(value)
        //     CloseDropdown();
        //     clearUlListSelf();
        //     // Если все еще есть значение
        //     if (input.value) {
        //       doQuery(value);
        //     // Если нет больше значение(Backspace)
        //     } 
        //   }

        // };

        var block_search = false;
        // query for dropdown list
        const doQuery = (value) => {
          // console.log("doQuery");
          let params = new Query();

          let sqlTxt = checkValue(value);
          params.where = sqlTxt;
          if (!block_search) {
            params.outFields = ["block, nameroom, roomnum"];
          } else {
            params.outFields = ["block"];
          }
          params.returnGeometry = false;
          params.returnDistinctValues = true;

          if (!block_search) {
            var qTask = new QueryTask({
              url: `https://kas.nu.edu.kz/arcgis/rest/services/NU/blockRoomsAddress/MapServer/0`
            });
          } else {
            //search for block
            var qTask = new QueryTask({
              url: `https://kas.nu.edu.kz/arcgis/rest/services/CampusMap2d_MIL1/MapServer/52`
            });
          }
          qTask
            .execute(params)
            .then(getResultsSelf)
            .catch(promiseRejected);
        };
        var dropdownListR = [];
        var dropdownListN = [];
        var dropdownListB = [];
        // get query results
        const getResultsSelf = (response) => {
          // console.log("features = ", response.features);
          let features = response.features;
          let length = features.length;
          if (length == 0) {
            let check_dangerLi = document.querySelector("#dangerLi");
            if (!check_dangerLi) {
              // console.log("Нет данных по данному запросу");
              let li = document.createElement("li");
              li.setAttribute("id", "dangerLi");
              li.setAttribute("class", "collection-item");
              li.innerHTML = "Нет данных по запросу";
              let active_element = document.activeElement.id;
              search_ul.appendChild(li);
              search_ul.classList.add("activeUl");
            }
          } else if (!block_search) {
            let index1 = 0;
            let index2 = 0;
            let len = 6;
            clearDropdownSelf();
            while (index1 < len) {
              // console.log('index2 = ',index2)
              if (index2 == length) {
                // console.log("index2==length");
                break;
              }
              // Проверяем заполнен ли атрибут и повторяется ли
              if (features[index2].attributes.roomnum != null) {
                if (features[index2].attributes.nameroom && features[index2].attributes.block) {
                  let li = document.createElement("li");
                  li.setAttribute("id", features[index2].attributes.roomnum);
                  li.setAttribute("class", "collection-item");
                  li.innerHTML = features[index2].attributes.roomnum + " (" + features[index2].attributes.nameroom + ", " + features[index2].attributes.block + ")";
                  dropdownListR.push(features[index2].attributes.roomnum);
                  dropdownListN.push(features[index2].attributes.nameroom);
                  dropdownListB.push(features[index2].attributes.block);
                  search_ul.appendChild(li);
                } else if (features[index2].attributes.block) {
                  let li = document.createElement("li");
                  li.setAttribute("id", features[index2].attributes.roomnum);
                  li.setAttribute("class", "collection-item");
                  li.innerHTML = features[index2].attributes.roomnum + " (" + features[index2].attributes.block + ")";
                  dropdownListR.push(features[index2].attributes.roomnum);
                  dropdownListN.push(null);
                  dropdownListB.push(features[index2].attributes.block);
                  search_ul.appendChild(li);
                } else if (features[index2].attributes.nameroom) {
                  let li = document.createElement("li");
                  li.setAttribute("id", features[index2].attributes.roomnum);
                  li.setAttribute("class", "collection-item");
                  li.innerHTML = features[index2].attributes.roomnum + " (" + features[index2].attributes.nameroom + ")";
                  dropdownListR.push(features[index2].attributes.roomnum);
                  dropdownListN.push(features[index2].attributes.nameroom);
                  dropdownListB.push(null);
                  search_ul.appendChild(li);
                } else {
                  let li = document.createElement("li");
                  li.setAttribute("id", features[index2].attributes.roomnum);
                  li.setAttribute("class", "collection-item");
                  li.innerHTML = features[index2].attributes.roomnum;
                  dropdownListR.push(features[index2].attributes.roomnum);
                  dropdownListN.push(null);
                  dropdownListB.push(null);
                  search_ul.appendChild(li);
                }
                index1++;
              }
              index2++;
            }
            if (index1 > 0) {
              search_ul.classList.add("activeUl");
            }
            // getForSelf(response.features);
          } else if (block_search) {
            let index1 = 0;
            let index2 = 0;
            let len = 6;
            clearDropdownSelf();
            while (index1 < len) {
              // console.log('index2 = ',index2)
              if (index2 == length) {
                // console.log("index2==length");
                break;
              }
              // Проверяем заполнен ли атрибут и повторяется ли
              if (features[index2].attributes.block != null) {
                if (checkIdentical(features[index2].attributes.block)) {
                  let li = document.createElement("li");
                  li.setAttribute("id", features[index2].attributes.block);
                  li.setAttribute("class", "collection-item");
                  li.innerHTML = features[index2].attributes.block;
                  dropdownListB.push(features[index2].attributes.block);
                  search_ul.appendChild(li);
                  index1++;
                }
                index2++;
              }
              if (index1 > 0) {
                search_ul.classList.add("activeUl");
              }
            }
          }
        };
        // Вызывается каждый раз, когда запрос отклоняется
        const promiseRejected = (error) => {
          console.error("Promise rejected: ", error.message);
        };
        
        const checkIdentical = (block) => {
          dropdownListB.forEach(el => {
            if (el != block) {
              return false;
            }
          })
          return true;
        }

        // checks which sql text to return
        const checkValue = (value) => {
          let text = '';
          // let value = value.toString();
          if (value.toLowerCase().includes("б") || value.toLowerCase().includes("blo")) {
            if (value.toLowerCase().includes("blo")) {
              console.log('blo')
              if (value.includes("b") || value.includes("B")) value = value.toLowerCase().replace("b","Б")
              if (value.includes("l")) value = value.replace("l","л")
              if (value.includes("o")) value = value.replace("o","о")
              if (value.includes("c")) value = value.replace("c","")
              if (value.includes("ck")) value = value.replace("ck","к")
              text = "block" + " LIKE '%" + value + "%'";
            } else {
              text = "block" + " LIKE '%" + value + "%'";
            }
            block_search = true;
          } else if (/[0-9]/.test(value)) {
            text = "lower(roomnum)" + " LIKE '%" + value + "%'";
            block_search = false;
          } else {
            text = "lower(nameroom)" + " LIKE '%" + value + "%'";
            block_search = false;
          }
          // console.log(text);
          return text;
        }      
        // Закрываем dropdownList
        const CloseDropdown = () => {
          // console.log("close dropdown")
          let activeUl = document.querySelector(".activeUl");
          if (activeUl) activeUl.classList.remove("activeUl");
        };
        // Обнуляет список dropdown
        const clearDropdownSelf = () => {
          dropdownList = [];
        };
        // Обнуляем список всех ul
        const clearUlListSelf = () => {
          search_ul.innerHTML = "";
          dropdownListR = [];
          dropdownListN = [];
          dropdownListB = [];
        };
        // Проверка анимации готовности
        const pulseAnimation = (bol) => {
          // console.log("pulse animation ", bol);
          let pulse = document.querySelector("a.waves-effect");
          if (bol) {
            if (!pulse.classList.contains("pulse")) {
              pulse.classList.add("pulse");
              // console.log("pulse add");
            }
          } else {
            if (pulse.classList.contains("pulse")) {
              pulse.classList.remove("pulse");
              // console.log("pulse remove");
            }
          }
        };

        // query after click to dropdown list
        const doQueryResult = () => {
          // console.log("doQuery");
          let sqlTxt = findSqlText();
          let params = new Query({
            where: sqlTxt
          });
          if (!block_search) {
            params.outFields = ["block, nameroom, roomnum, floor"];
          } else {
            params.outFields = ["block"];
          }
          
          params.returnGeometry = true;
          params.returnDistinctValues = false;

          if (!block_search) {
            var qTask = new QueryTask({
              url: `https://kas.nu.edu.kz/arcgis/rest/services/NU/blockRoomsAddress/MapServer/0`
            });
          } else {
            // search for block
            var qTask = new QueryTask({
              url: `https://kas.nu.edu.kz/arcgis/rest/services/CampusMap2d_MIL1/MapServer/52`
            });
          }

          qTask
            .execute(params)
            .then(getResultsEnd)
            .catch(promiseRejected);
        }
        
        // get query results
        const getResultsEnd = (response) => {
          console.log("features = ", response.features);
          let features = response.features;
          let length = features.length;
          let geometry = features[0].geometry;
          // console.log(centroid)
          // if (length == 1) {
            let feature = features.forEach(features => {
              if (!block_search) {
                findLayer(features.attributes.floor)
                features.popupTemplate = {
                  title: "Информация",
                  content: 
                  "<b>Кабинет: </b> " + features.attributes.roomnum + " (" + features.attributes.nameroom + ")</br>"+
                  "<b>Блок: </b> " + features.attributes.block + "</br>"+
                  "<b>Этаж: </b> " + features.attributes.floor + "</br>"+
                  "</br>"+
                  "<a class='waves-effect waves-light btn-small small-padding'"+
                  "onClick='createDirection(" + geometry.latitude + "," + geometry.longitude + ")' style='color: white!important;'>"+
                  "<i class='material-icons left medium-margin'>transfer_within_a_station</i>Построить маршрут</a></br>"
                  
                }
              } else {
                features.popupTemplate = {
                  title: "Информация",
                  content: "<b>Блок: </b> " + features.attributes.block + "</br>"
                }
              }
              features.symbol = {
                type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                color: 'green',
                style: "solid",
                outline: {  // autocasts as new SimpleLineSymbol()
                  color: "green",
                  width: 1
                }
              };
              search_result_graphic.add(features);
            })
            // console.log(map.layers)
            // console.log(features)
            view.goTo({
              target: geometry,
              scale: 500
            }).then(openPopup);

            function openPopup(info) {
              view.popup.open({
                features: features,
                featureMenuOpen: true,
                updateLocationEnabled: true
              })
            }
            // pulseAnimation(false);
          // }

        };

        // return sql text request
        const findSqlText = () => {
          // console.log(dropdownListR)
          // console.log(dropdownListN)
          // console.log(dropdownListB)
          let text = '';
          if (!block_search) {
            length = dropdownListR.length;
            len = 0;
            while (len < length) {
              if (search_input.value == dropdownListR[len]) {
                text = "roomnum = '" + dropdownListR[len] + "'";
                if (dropdownListN[len]) text += " AND nameroom = '" + dropdownListN[len] + "'";
                if (dropdownListB[len]) text += " AND block = '" + dropdownListB[len] + "'";
                break;
              }
              len++;
            }
          } else {
            length = dropdownListB.length;
            len = 0;
            while (len < length) {
              if (search_input.value == dropdownListB[len]) {
                text = "block = '" + dropdownListB[len] + "'";
                break;
              }
              len++;
            }
          }
          return text;
        }
        
        // Click to "Построить маршрут"
        window.createDirection = (lat, long) => {
          view.popup.close();
          finish_point_graphic.removeAll();
          search_result_graphic.removeAll();
          route_graphic.removeAll();

          // console.log(lat, long)
          finish_point = {
            type: "point",
            latitude: lat,
            longitude: long
          }

          addGraphic("finish", checkFinishPoint(finish_point.x, finish_point.y));
          getRoute(false);
          // let input1 = document.querySelectorAll("ol.esri-directions__stops > li:nth-child(1) > div.esri-directions__stop-input > div.esri-search.esri-widget >"+
          // "div.esri-search--multiple-sources.esri-search__container > div.esri-search__input-container > form > input");
          // input1[0].value = '3.322'
          // let input2 = document.querySelectorAll("ol.esri-directions__stops > li:nth-child(2) > div.esri-directions__stop-input > div.esri-search.esri-widget >"+
          // "div.esri-search--multiple-sources.esri-search__container > div.esri-search__input-container > form > input");
          
          // directionsWidget.getDirections();
        }

        // add start/finish point
        const addGraphic = (type, point) => {
          let graphic = new Graphic();
          if (type == "start") {
            graphic.symbol = {
              type: "picture-marker",
              url:
                "./assets/direction-maneuvers/Start24.svg",
              width: 18,
              height: 18,
              // yoffset: 11,
              // xoffset: -11
            },
            graphic.geometry = point;
            start_point_graphic.add(graphic)
          } else if (type == "finish") {
            graphic.symbol = {
              type: "picture-marker",
              url:
                "./assets/direction-maneuvers/End24.svg",
              width: 18,
              height: 18,
              // yoffset: 11
            },
            graphic.geometry = point;
            finish_point_graphic.add(graphic);
          }
        }
        
        var route_task = "elevator";
        // var direction_extent = new Geometry();// route directions extent

        var check_getRoute = false;
        var check_defaultRoute = false;
        // get route
        const getRoute = (standart) => {
          console.log("getroute")
          section_ol.innerHTML = "";
          finish_point_graphic.removeAll();
          // search_result_graphic.removeAll();
          route_graphic.removeAll();
          // addGraphic("start", start_point);
          addGraphic("finish", checkFinishPoint(finish_point.latitude, finish_point.longitude));
          view.ui.empty("top-right");
          // Setup the route parameters
          var routeParams = new RouteParameters({
            stops: new FeatureSet({
                // features: view.graphics.toArray() // Pass the array of graphics
                features: [{
                    geometry: start_point_graphic.graphics.items[0].geometry
                  },{
                    geometry: finish_point_graphic.graphics.items[0].geometry
                  }
                ]
            }),
            returnDirections: true
          });
          if (standart) {
            check_defaultRoute = true;
            // Get the route
            standartRouteTask.solve(routeParams).then((data) => {
              console.log(data)
              let features = data.routeResults[0].directions.features;
              // Display the route
              addSymbol(features);

              // Show the direction list
              let geom_route = route_graphic.graphics.items[0].geometry.clone();
              geom_route.spatialReference = {
                wkid: 4326
              }
              
              view.goTo({
                target: geom_route,
                scale: 2500
              });

              addRouteList(features);

            });
            view.ui.add(direction_div, "top-right");
            switches.style.display = "none"
          } else if (route_task == "stairs") {
            // Get the route
            routeTaskStairs.solve(routeParams).then((data) => {
              console.log("stairs data",data)
              check_getRoute = true;
              let features = data.routeResults[0].directions.features;
              // Display the route
              addSymbol(features);

              // Show the direction list
              let geom_route = route_graphic.graphics.items[0].geometry.clone();
              geom_route.spatialReference = {
                wkid: 4326
              }
              
              view.goTo({
                target: geom_route,
                scale: 2500
              });

              addRouteList(features);

            });
            view.ui.add(direction_div, "top-right");
          } else if (route_task == "elevator") {
            routeTaskElev.solve(routeParams).then((data) => {
              check_getRoute = true;
              console.log("elev data",data)
              let features = data.routeResults[0].directions.features;
              // Display the route
              // addSymbol(data.routeResults);
              addSymbol(features);

              // Show the direction list
              let geom_route = route_graphic.graphics.items[0].geometry.clone();
              geom_route.spatialReference = {
                wkid: 4326
              }
              // console.log(geom_route)
              view.goTo({
                target: geom_route,
                scale: 2500
              });

              addRouteList(features);

            })
            view.ui.add(direction_div, "top-right");
          }
          // console.log(view.graphics)
          console.log(check_getRoute)
          if (!check_getRoute && !check_defaultRoute) {
            console.log("check")
            getRoute(true);
            check_defaultRoute = true;
          }
        }

        var route_symbol = false;
        var route_default_symbol = {
          type: "simple-line",
          color: [46, 204, 64],
          width: 3
        };
        var route_active_symbol = {
          type: "simple-line",
          color: [0, 255, 255],
          width: 5
        }
        var index_route = null;
        // add symbol to results
        const addSymbol = (route_result) => {
          route_result.forEach((result) => {
            // result.route.symbol = {
            result.symbol = route_default_symbol;
            // route_graphic.add(result.route);
            route_graphic.add(result);
          });
        }

        // create route list
        const addRouteList = (features) => {
          // console.log(features)
          features.forEach((result, i) => {
            let section_li = document.createElement("li");
            section_li.classList = "esri-directions__maneuver";
            section_li.id = i;
            
            let img = document.createElement("img");
            img.classList = "esri-directions__maneuver-icon";
            img.setAttribute("src", addImg(result.attributes.text));

            let div1 = document.createElement("div");
            div1.classList = "esri-directions__maneuver-costs-container";

            let span = document.createElement("span");
            span.innerHTML = result.attributes.text;

            let div2 = document.createElement("div");
            div2.classList = "esri-directions__maneuver-costs";

            let div31 = document.createElement("div");
            div31.classList = "esri-directions__horizontal-splitter";
            let div32 = document.createElement("div");
            div32.classList = "esri-directions__cost--intermediate";
            div32.setAttribute("title", "Расстояние");
            div32.innerHTML = result.attributes.length.toFixed(1) + " meters";

            div2.appendChild(div31);
            div2.appendChild(div32);
            div1.appendChild(span);
            div1.appendChild(div2);
            section_li.appendChild(img);
            section_li.appendChild(div1);
            section_ol.appendChild(section_li);
            section_li.onclick = (e) => {
              // console.log(e)
              // Change color on route
              let index = e.path.findIndex(el => el.className == "esri-directions__maneuver")
              let text = e.path[index].children[1].children[0].innerHTML;
              let text_id = e.path[index].id;
              if (route_symbol && index_route) {
                route_graphic.graphics.items[index_route].symbol = route_default_symbol;
              }
              index_route = text_id;
              route_graphic.graphics.items[text_id].symbol = route_active_symbol;
              route_symbol = true;
              
              // Change floor
              if (result.attributes.text.includes("Start")) {
                let j = 1;
                if (!features[i+j].attributes.text.indexOf("floor")) {
                  j++;
                } else {
                  let index = features[i+j].attributes.text.indexOf("floor");
                  let floor_number = features[i+j].attributes.text.slice(index+6,index+7);

                  console.log(index)
                  findLayer(Number(floor_number));
                }
              } else if (result.attributes.text.includes("floor")) {
                let index = result.attributes.text.indexOf("floor");
                let floor_number = result.attributes.text.slice(index+6,index+7);
                
                findLayer(Number(floor_number));
              } else {
                let j = 1;
                if (!features[i-j].attributes.text.indexOf("floor")) {
                  j++;
                } else {
                  let index = features[i-j].attributes.text.indexOf("floor");
                  let floor_number = features[i-j].attributes.text.slice(index+6,index+7);
                  console.log(index)
                  
                  findLayer(Number(floor_number));
                }
              }
            }
          });
        }

        // add image for direction list
        const addImg = (text) => {
          if (text.indexOf("Start", 0) == 0) {
            return "./assets/direction-maneuvers/Start24.svg";
          } else if (text.indexOf("Finish", 0) == 0) {
            return "./assets/direction-maneuvers/End24.svg";
          } else if (text.includes("elevator")) {
            return "./assets/direction-maneuvers/Elevator24.svg";
          } else if (text.includes("stairs")) {
            return "./assets/direction-maneuvers/Stairs24.svg";
          } else if (text.includes("escalator")) {
            return "./assets/direction-maneuvers/Escalator24.svg";
          } else if (text.indexOf("Go", 0) == 0) {
            return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/straight.png" ;
          } else if (text.indexOf("Continue", 0) == 0) {
            return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/straight.png";
          } else if (text.indexOf("Turn left", 0) == 0) {
            if (text.includes("immediately turn right")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/left-right.png";
            } else if (text.includes("immediately turn left")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/left-left.png";
            } else {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/left.png";
            }
          } else if (text.indexOf("Turn right", 0) == 0) {
            if (text.includes("immediately turn right")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/right-right.png";
            } else if (text.includes("immediately turn left")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/right-left.png";
            } else {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/right.png";
            }
          } else if (text.indexOf("Bear left", 0) == 0) {//??
            return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/straight.png";
          } else if (text.indexOf("Bear right", 0) == 0) {//??
            return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/straight.png";
          } else if (text.indexOf("sharp left", 0) == 0) {
            if (text.includes("immediately turn right")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/left-right.png";
            } else if (text.includes("immediately turn left")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/left-left.png";
            } else {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/sharp-left.png";
            }
          } else if (text.indexOf("sharp right", 0) == 0) {
            if (text.includes("immediately turn right")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/right-right.png";
            } else if (text.includes("immediately turn left")) {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/right-left.png";
            } else {
              return "https://js.arcgis.com/4.13/esri/themes/base/images/maneuvers/sharp-right.png";
            }
          } else {
            return "./assets/direction-maneuvers/Unknown_Manuver24.svg";
          }//??not all

        }

        // var point_finish;
        // const findLocator = (value) => {
        //   let address = {
        //     "SingleKey": value
        //   };
        //   locator.addressToLocations({
        //     address: address,
        //     outFields: ["*"],
        //     // outSpatialReference: {
        //     //   wkid: 32642
        //     // }
        //   })
        //   .then(function(results) {
        //     results.forEach(function(result){
        //       console.log("result",result)
        //       let spatialRef = new SpatialReference ({
        //         wkid: 102100,
        //         // latestWkid: 3857,
        //         // isWebMercator: true,
        //         // isWrappable: true
        //       })//32642
        //       point_finish = new Point({
        //         x: result.location.x,
        //         y: result.location.y,
        //         spatialReference: spatialRef
        //       });
        //       console.log("point finish",point_finish)
        //     });
            
        //   }, function(err) { // Show no address found
        //     console.log('error')
        //     showPopup("No address found.", evt.mapPoint);
        //   });
        // }

        // Display the directions
        var direction_div = document.createElement("div");
        direction_div.classList = "esri-widget esri-widget--panel esri-directions__scroller direction-div";
        direction_div.id = "direction_div";
        var direction_div_title = document.createElement("div");
        direction_div_title.classList = "row border-bottom title";
        var title_name = document.createElement("div");
        title_name.classList = "col s11 dir-name";
        title_name.innerHTML = "Маршрутный лист";
        var close_a = document.createElement("a");
        close_a.classList = "col s1 close";
        var direction_divider = document.createElement("div");
        direction_divider.classList = "divider";
        var direction_section = document.createElement("section");
        direction_section.classList = "esri-directions__maneuver-section";
        var direction_button = document.createElement("div");
        direction_button.classList = "button-stairs-elevator";
        direction_button.id = "direction_button";
        var switches = document.createElement("div");
        switches.classList = "switch";
        var switches_label = document.createElement("label");
        var label_input = document.createElement("input");
        label_input.type = "checkbox";
        var label_span = document.createElement("span");
        label_span.classList = "lever";
        var elev_text = "Лифт";
        var stairs_text = "Лестница";
        direction_button.appendChild(switches);
        switches.appendChild(switches_label);
        switches_label.appendChild(label_input);
        switches_label.appendChild(label_span);
        label_input.before(elev_text);
        label_span.after(stairs_text);
        // var button_a = document.createElement("a");
        // button_a.classList = "waves-effect waves-light btn-small small-padding";
        // button_a.id = "button_stairs_elev";
        var section_ol = document.createElement("ol");
        section_ol.classList = "esri-directions__maneuver-list";
        section_ol.style.marginTop = 0;
        section_ol.style.paddingTop = "15px";
        direction_div_title.appendChild(title_name);
        direction_div.appendChild(direction_div_title);
        direction_div_title.appendChild(close_a);
        direction_div.appendChild(direction_button);
        direction_div.appendChild(direction_divider);
        direction_div.appendChild(direction_section);
        // direction_button.appendChild(button_a);
        // button_a.innerHTML = "Хочу по лестнице!";
        direction_section.appendChild(section_ol);
        
        // change route list(stairs/elevator)
        label_input.onchange = () => {
          if (route_task == "stairs") {
            route_task = "elevator";
            getRoute(false);
            return;
            // let stairs_elev_a = document.getElementById('button_stairs_elev');
            // stairs_elev_a.innerHTML = "Хочу по лестнице!";
          } else if (route_task == "elevator") {
            route_task = "stairs";
            getRoute(false);
            return;
            // let stairs_elev_a = document.getElementById('button_stairs_elev');
            // stairs_elev_a.innerHTML = "Хочу по лифту!";
          }
        }

        // close all graphics && route list
        close_a.onclick = () => {
          finish_point_graphic.removeAll();
          search_result_graphic.removeAll();
          route_graphic.removeAll();
          view.popup.close();
          view.ui.empty("top-right");
        }

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="floorBlockInfo" class="floorBlockInfo"></div>
    <div id="search_menu" class="search-menu">
      <div id="search" class="search-item input-field">
        <input id="search_input" class="validate" type="text" autocomplete="off" />
        <ul id="search_ul" class="collection"></ul>
        <label id="search_label" for="search_input">Поиск</label>
      </div>
      <div id="search_button" class="button">
        <a class="waves-effect waves-light btn-small small-padding">
          <i class="material-icons left small-margin">search</i>
          Найти
        </a>
      </div>
    </div>
  </body>
</html>
